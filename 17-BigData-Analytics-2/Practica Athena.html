<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_uarm2fjudeqd-8>li:before{content:"-  "}.lst-kix_6sz5saw6o2ej-5>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-5,lower-roman) ". "}.lst-kix_6sz5saw6o2ej-7>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-7,lower-latin) ". "}.lst-kix_6sz5saw6o2ej-2>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-2,lower-roman) ". "}.lst-kix_6sz5saw6o2ej-6>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-6,decimal) ". "}.lst-kix_uarm2fjudeqd-5>li:before{content:"-  "}ol.lst-kix_6sz5saw6o2ej-0.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-0 0}.lst-kix_uarm2fjudeqd-4>li:before{content:"-  "}.lst-kix_6sz5saw6o2ej-1>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-1,lower-latin) ". "}.lst-kix_uarm2fjudeqd-3>li:before{content:"-  "}.lst-kix_6sz5saw6o2ej-0>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-0,decimal) ". "}.lst-kix_6sz5saw6o2ej-8>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-8,lower-roman) ". "}.lst-kix_6sz5saw6o2ej-4>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-4}ol.lst-kix_6sz5saw6o2ej-3.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-3 0}.lst-kix_uarm2fjudeqd-6>li:before{content:"-  "}.lst-kix_uarm2fjudeqd-7>li:before{content:"-  "}.lst-kix_6sz5saw6o2ej-3>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-3}ol.lst-kix_6sz5saw6o2ej-8.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-8 0}.lst-kix_6sz5saw6o2ej-0>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-0}.lst-kix_6sz5saw6o2ej-6>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-6}ul.lst-kix_uarm2fjudeqd-8{list-style-type:none}ul.lst-kix_uarm2fjudeqd-7{list-style-type:none}.lst-kix_6sz5saw6o2ej-3>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-3,decimal) ". "}.lst-kix_6sz5saw6o2ej-4>li:before{content:"" counter(lst-ctn-kix_6sz5saw6o2ej-4,lower-latin) ". "}ul.lst-kix_uarm2fjudeqd-0{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-1{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-0{list-style-type:none}ul.lst-kix_uarm2fjudeqd-2{list-style-type:none}ul.lst-kix_uarm2fjudeqd-1{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-2.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-2 0}ul.lst-kix_uarm2fjudeqd-4{list-style-type:none}ul.lst-kix_uarm2fjudeqd-3{list-style-type:none}ul.lst-kix_uarm2fjudeqd-6{list-style-type:none}ul.lst-kix_uarm2fjudeqd-5{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-8{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-7{list-style-type:none}.lst-kix_6sz5saw6o2ej-1>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-1}ol.lst-kix_6sz5saw6o2ej-6{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-5{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-4{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-5.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-5 0}ol.lst-kix_6sz5saw6o2ej-3{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-2{list-style-type:none}ol.lst-kix_6sz5saw6o2ej-6.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-6 0}.lst-kix_6sz5saw6o2ej-7>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-7}ol.lst-kix_6sz5saw6o2ej-1.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-1 0}.lst-kix_uarm2fjudeqd-1>li:before{content:"-  "}.lst-kix_uarm2fjudeqd-0>li:before{content:"-  "}.lst-kix_uarm2fjudeqd-2>li:before{content:"-  "}.lst-kix_6sz5saw6o2ej-5>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-5}ol.lst-kix_6sz5saw6o2ej-4.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-4 0}.lst-kix_6sz5saw6o2ej-8>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-8}.lst-kix_6sz5saw6o2ej-2>li{counter-increment:lst-ctn-kix_6sz5saw6o2ej-2}ol.lst-kix_6sz5saw6o2ej-7.start{counter-reset:lst-ctn-kix_6sz5saw6o2ej-7 0}ol{margin:0;padding:0}table td,table th{padding:0}.c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c35{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c2{color:#5f6364;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10.5pt;font-family:"Courier New";font-style:normal}.c11{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c38{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:26pt;font-family:"Arial";font-style:normal}.c14{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Courier New";font-style:normal}.c1{color:#333333;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10.5pt;font-family:"Courier New";font-style:normal}.c4{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c28{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c10{font-size:10.5pt;font-family:"Courier New";color:#333333;font-weight:700}.c9{font-size:10pt;font-family:"Courier New";color:#242729;font-weight:400}.c3{font-size:10.5pt;font-family:"Courier New";color:#333333;font-weight:400}.c7{font-size:10.5pt;font-family:"Courier New";color:#5f6364;font-weight:400}.c16{border-spacing:0;border-collapse:collapse;margin-right:auto}.c37{padding-top:0pt;padding-bottom:11pt;line-height:1.0;text-align:left}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c13{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c39{text-decoration:none;vertical-align:baseline;font-style:normal}.c36{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c24{font-size:10.5pt;font-family:"Courier New"}.c32{color:inherit;text-decoration:inherit}.c20{font-size:10.5pt;color:#1990b8}.c18{color:#ff0000;font-weight:700}.c15{font-size:10.5pt;color:#2f9c0a}.c12{font-weight:400;font-family:"Courier New"}.c40{margin-left:36pt;padding-left:0pt}.c34{padding:0;margin:0}.c30{color:#1990b8;font-weight:400}.c26{color:#2f9c0a;font-weight:400}.c31{color:#a67f59;font-weight:400}.c19{font-size:10.5pt;color:#a67f59}.c25{color:#93c47d}.c21{font-weight:700}.c27{font-family:"Courier New"}.c17{height:0pt}.c33{height:20pt}.c29{font-size:10pt}.c23{height:21pt}.c41{color:#2b91af}.c5{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c36"><p class="c35 title" id="h.m04vfwuljl5h"><span class="c38">Pr&aacute;ctica de Athena</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En esta pr&aacute;ctica vamos a consumir con logs de un ELB situados en un bucket p&uacute;blico de S3.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Los mismos se pueden ver en esta URL:</span></p><p class="c4"><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://console.aws.amazon.com/s3/buckets/athena-examples/elb/raw/2015/01/01/?region%3Dus-east-1&amp;sa=D&amp;ust=1595373300019000&amp;usg=AOvVaw0QfoWYVpIMPl1xQWLZ4sS5">https://console.aws.amazon.com/s3/buckets/athena-examples/elb/raw/?region=us-east-1</a></span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Este es un ejemplo del contenido de los mismos:</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.e16035b340300b0f470f292af004e6df278c45e8"></a><a id="t.0"></a><table class="c16"><tbody><tr class="c17"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c12">2015-01-01T00:00:00.022719Z elb_demo_005 244.218.91.244:2255 172.36.231.239:443 0.000878 0.000803 0.000891 200 200 0 1886 &quot;GET https://www.example.com/jobs/376 HTTP/1.1&quot; &quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36&quot; DHE-RSA-AES128-SHA TLSv1.2</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En esta pr&aacute;ctica vamos a ver c&oacute;mo se pueden consumir esos datos no estructurados usando SQL gracias a Athena.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Es necesario crear el siguiente bucket y directorios dentro del mismo, los cuales ser&aacute;n la ruta del output por default de Athena (reemplazar [SUFFIX] por el nombre de usuario del alumno).</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c6"><span class="c10">s3://dh-2020</span><span class="c12">-</span><span class="c21 c27">[SUFFIX]</span><span class="c10">/athena-practice/results/</span></p><h1 class="c11" id="h.32zcx4w8frfs"><span class="c14">Tarea 1: Crear una tabla en Athena</span></h1><p class="c4"><span class="c0">(N&oacute;tese que antes de arrancar se tuvo que configurar una ruta de S3 en la cual Athena deja sus resultados.)</span></p><p class="c4 c5"><span class="c0"></span></p><ol class="c34 lst-kix_6sz5saw6o2ej-0 start" start="1"><li class="c4 c40"><span>Ir a la consola de Athena: </span><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://console.aws.amazon.com/athena/home?force%26region%3Dus-east-1%23query&amp;sa=D&amp;ust=1595373300023000&amp;usg=AOvVaw1i99X0OsXwxfyzU72eENOF">https://console.aws.amazon.com/athena/home?force&amp;region=us-east-1#query</a></span><span class="c0"><br>Deber&iacute;an encontrarse con una pantalla como esta:</span></li></ol><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 384.00px;"><img alt="" src="https://lh5.googleusercontent.com/jpMhe1Cunww2H7HByqkRdcL13J0588MIdx1NTTVjmN6JWZ15jshV3EjzjtJP7tvu7u_g-0Lo63ZrG5hv3F9znb6k3wTPK8AzM8_H3STjBemledWJkdMj77ApG0wSCQ7iWlhGUZlz" style="width: 624.00px; height: 384.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c4 c5"><span class="c0"></span></p><ol class="c34 lst-kix_6sz5saw6o2ej-0" start="2"><li class="c4 c40"><span class="c0">Crear la tabla para consumir datos de S3 corriendo el siguiente c&oacute;digo en el cuadro &ldquo;New query&rdquo; :</span></li></ol><p class="c4 c5"><span class="c0"></span></p><a id="t.8f206460fdded302f9858903041167f02ab1b86b"></a><a id="t.1"></a><table class="c16"><tbody><tr class="c17"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c12">CREATE EXTERNAL TABLE IF NOT EXISTS elb_logs_raw_native_</span><span class="c21 c27">[SUFFIX]</span><span class="c8">&nbsp;(</span></p><p class="c6"><span class="c8">&nbsp; request_timestamp string, </span></p><p class="c6"><span class="c8">&nbsp; elb_name string, </span></p><p class="c6"><span class="c8">&nbsp; request_ip string, </span></p><p class="c6"><span class="c8">&nbsp; request_port int, </span></p><p class="c6"><span class="c8">&nbsp; backend_ip string, </span></p><p class="c6"><span class="c8">&nbsp; backend_port int, </span></p><p class="c6"><span class="c8">&nbsp; request_processing_time double, </span></p><p class="c6"><span class="c8">&nbsp; backend_processing_time double, </span></p><p class="c6"><span class="c8">&nbsp; client_response_time double, </span></p><p class="c6"><span class="c8">&nbsp; elb_response_code string, </span></p><p class="c6"><span class="c8">&nbsp; backend_response_code string, </span></p><p class="c6"><span class="c8">&nbsp; received_bytes bigint, </span></p><p class="c6"><span class="c8">&nbsp; sent_bytes bigint, </span></p><p class="c6"><span class="c8">&nbsp; request_verb string, </span></p><p class="c6"><span class="c8">&nbsp; url string, </span></p><p class="c6"><span class="c8">&nbsp; protocol string, </span></p><p class="c6"><span class="c8">&nbsp; user_agent string, </span></p><p class="c6"><span class="c8">&nbsp; ssl_cipher string, </span></p><p class="c6"><span class="c8">&nbsp; ssl_protocol string ) </span></p><p class="c6"><span class="c8">ROW FORMAT SERDE &#39;org.apache.hadoop.hive.serde2.RegexSerDe&#39;</span></p><p class="c6"><span class="c8">WITH SERDEPROPERTIES (</span></p><p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#39;serialization.format&#39; = &#39;1&#39;,&#39;input.regex&#39; = &#39;([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:\-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \\\&quot;([^ ]*) ([^ ]*) (- |[^ ]*)\\\&quot; (\&quot;[^\&quot;]*\&quot;) ([A-Z0-9-]+) ([A-Za-z0-9.-]*)$&#39; ) </span></p><p class="c6"><span class="c12">LOCATION &#39;</span><span class="c21 c27">s3://athena-examples/elb/raw/</span><span class="c8">&#39;;</span></p><p class="c6 c5"><span class="c0"></span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Un punto importante del &uacute;ltimo comando es que incluye una expresi&oacute;n regular que se encarga de parsear el contenido de los archivos de manera que se pueda consumir en forma de tablas.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En este deber&iacute;an ver el nombre de la nueva tabla en el panel de la izquierda (puede que sea necesario hacer un refresh con el &iacute;cono marcado):</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 425.33px;"><img alt="" src="https://lh4.googleusercontent.com/JybPK_ZA8AdaI2bh36PpxLUtpCIpwkEPkyye2ASt0NJDYr3rUAIGy3rgMUEI-0QylcQ0C2LLn6pmpUAZne6dr5mC8sHPtnp9PIqKEglEEh_Omlk4WGmWW9zuESB1LkvggjjcvFLM" style="width: 624.00px; height: 425.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Para lanzar una query sobre los datos cargados basta con escribirla en el cuadro mismo cuadro donde se escribi&oacute; el CREATE:</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.aee0210ff731a5dca86f92c8e6091cf7467c9cd9"></a><a id="t.2"></a><table class="c16"><tbody><tr class="c17"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c12">SELECT * FROM &quot;elb_logs_raw_native_</span><span class="c21 c27">[SUFFIX]</span><span class="c12">&quot; limit 10;</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4 c5"><span class="c0"></span></p><hr style="page-break-before:always;display:none;"><h1 class="c11 c33" id="h.b7bhvok4h3zw"><span class="c14"></span></h1><h1 class="c11" id="h.8v8r2044s686"><span class="c14">Tarea 2: Crear una tabla particionada</span></h1><p class="c4"><span class="c0">Al igual que en el paso anterior vamos a crear una tabla desde la consola de Athena:</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.86255bebd596708b0bad1bd7018903c4e61d10ce"></a><a id="t.3"></a><table class="c16"><tbody><tr class="c17"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c3">CREATE EXTERNAL TABLE IF NOT EXISTS elb_logs_raw_native_part_</span><span class="c10">[SUFFIX]</span><span class="c1">&nbsp;(</span></p><p class="c6"><span class="c1">&nbsp; request_timestamp string, </span></p><p class="c6"><span class="c1">&nbsp; elb_name string, </span></p><p class="c6"><span class="c1">&nbsp; request_ip string, </span></p><p class="c6"><span class="c1">&nbsp; request_port int, </span></p><p class="c6"><span class="c1">&nbsp; backend_ip string, </span></p><p class="c6"><span class="c1">&nbsp; backend_port int, </span></p><p class="c6"><span class="c1">&nbsp; request_processing_time double, </span></p><p class="c6"><span class="c1">&nbsp; backend_processing_time double, </span></p><p class="c6"><span class="c1">&nbsp; client_response_time double, </span></p><p class="c6"><span class="c1">&nbsp; elb_response_code string, </span></p><p class="c6"><span class="c1">&nbsp; backend_response_code string, </span></p><p class="c6"><span class="c1">&nbsp; received_bytes bigint, </span></p><p class="c6"><span class="c1">&nbsp; sent_bytes bigint, </span></p><p class="c6"><span class="c1">&nbsp; request_verb string, </span></p><p class="c6"><span class="c1">&nbsp; url string, </span></p><p class="c6"><span class="c1">&nbsp; protocol string, </span></p><p class="c6"><span class="c1">&nbsp; user_agent string, </span></p><p class="c6"><span class="c1">&nbsp; ssl_cipher string, </span></p><p class="c6"><span class="c1">&nbsp; ssl_protocol string ) </span></p><p class="c6"><span class="c10 c39">PARTITIONED BY(year string, month string, day string)</span></p><p class="c6"><span class="c1">ROW FORMAT SERDE &#39;org.apache.hadoop.hive.serde2.RegexSerDe&#39;</span></p><p class="c6"><span class="c1">WITH SERDEPROPERTIES (</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#39;serialization.format&#39; = &#39;1&#39;,&#39;input.regex&#39; = &#39;([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:\-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \\\&quot;([^ ]*) ([^ ]*) (- |[^ ]*)\\\&quot; (\&quot;[^\&quot;]*\&quot;) ([A-Z0-9-]+) ([A-Za-z0-9.-]*)$&#39; )</span></p><p class="c6"><span class="c3">LOCATION &#39;</span><span class="c10">s3://athena-examples/elb/raw/</span><span class="c3">&#39;;</span></p><p class="c6 c5"><span class="c0"></span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><hr style="page-break-before:always;display:none;"><h1 class="c11 c33" id="h.kqirwla7n3yv"><span class="c14"></span></h1><h1 class="c11" id="h.7eh8vh2smfmn"><span class="c14">Tarea 3: Carga particiones de la tabla</span></h1><p class="c4"><span class="c0">Para esto vamos a usar ALTER TABLE &hellip; ADD PARTITION:</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.be598b1ca4416200ed40977646f8362f95d877fc"></a><a id="t.4"></a><table class="c16"><tbody><tr class="c17"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c3">ALTER TABLE elb_logs_raw_native_part_</span><span class="c10">[SUFFIX]</span><span class="c3">&nbsp;ADD PARTITION (year=&#39;2015&#39;,month=&#39;01&#39;,day=&#39;01&#39;) location &#39;s3://athena-examples/elb/raw/2015/01/01/&#39;</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En este punto deber&iacute;amos poder listar la nueva partici&oacute;n tabla particionada:</span></p><a id="t.bac4e18551807bb33a6abd80a82f2371e58886ff"></a><a id="t.5"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c3">show partitions elb_logs_raw_native_part_</span><span class="c10">[SUFFIX]</span><span class="c3">;</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Resultado:</span></p><a id="t.77afbd94299d32499e52257ddf1388afdc414d3c"></a><a id="t.6"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c3">year=2015/month=01/day=01</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">N&oacute;tese que este proceso se tendr&iacute;a que realizar para cada partici&oacute;n nueva.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Ahora podemos hacer queries restringidas por partici&oacute;n:</span></p><a id="t.08e96b8926efda25628cbb625fa73eccfc057ea3"></a><a id="t.7"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c1">SELECT distinct(elb_response_code),</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;count(url)</span></p><p class="c6"><span class="c3">FROM elb_logs_raw_native_part_</span><span class="c10">[SUFFIX]</span></p><p class="c6"><span class="c1">WHERE year=&#39;2015&#39;</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; AND month= &#39;01&#39;</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; AND day=&#39;01&#39;</span></p><p class="c6"><span class="c1">GROUP BY &nbsp;elb_response_code</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Resultado:</span></p><a id="t.2f223d7582ee4c028f0fae70f2b1b3238cd5d0a9"></a><a id="t.8"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elb_response_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_col1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elb_response_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_col1</span></p><p class="c6"><span class="c1">1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;404&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;524847</span></p><p class="c6"><span class="c1">2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9442408</span></p><p class="c6"><span class="c1">3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;302&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;104573</span></p><p class="c6"><span class="c1">4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;301&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;105179</span></p><p class="c6"><span class="c1">5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;314951</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><hr style="page-break-before:always;display:none;"><h1 class="c11 c33" id="h.6gbvxl7tgzoj"><span class="c14"></span></h1><h1 class="c11" id="h.3hbdp8e1y0kf"><span class="c14">Tarea 4: Realizar queries desde Python usando boto3</span></h1><p class="c4"><span class="c0">En esta pr&aacute;ctica vamos a ver c&oacute;mo utilizar Athena de forma program&aacute;tica y c&oacute;mo realizar queries asincr&oacute;nicas.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span>Aqu&iacute; sugerimos utilizar un notebook (</span><span class="c21">Jupyter</span><span>&nbsp;por ejemplo) para ir ejecutando el c&oacute;digo secuencialmente. Tambi&eacute;n se puede utilizar cualquier otro entorno que cuente con </span><span class="c21">Python</span><span class="c0">.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span>Deber&aacute;n tener instalado boto3. </span><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://pypi.org/project/boto3/&amp;sa=D&amp;ust=1595373300052000&amp;usg=AOvVaw2WXzlE9-rLoH5PdHYqbn2e">Tutorial</a></span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En el nuevo notebook lo primero que vamos a hacer es importar la librer&iacute;a boto3 y crear el cliente de athena (Reemplazar el API_KEY y SECRET_API_KEY con las credenciales del alumno). </span></p><a id="t.46794bbdd9cb1a3678443d418ec25de5d5f8b56f"></a><a id="t.9"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c1">import boto3</span></p><p class="c6"><span class="c1">from time import sleep</span></p><p class="c6 c5"><span class="c1"></span></p><p class="c37"><span class="c9">session = boto3.</span><span class="c12 c29 c41">Session</span><span class="c9">( aws_access_key_id= </span><span class="c18 c27 c29">API_KEY</span><span class="c9">, aws_secret_access_key= </span><span class="c18 c27 c29">SECRET_API_KEY</span><span class="c9">, )</span></p><p class="c6"><span class="c1">athena = boto3.client(&quot;athena&quot;, region_name=&#39;us-east-1&#39;)</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Luego vamos a correr una query contra las tablas creadas:</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.1f69a5fba7dc84cfc2330b0e44392f77033cc05c"></a><a id="t.10"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c3">query = &#39;SELECT * FROM &quot;elb_logs_raw_native_</span><span class="c10">[SUFFIX]</span><span class="c1">&quot; limit 10;&#39;</span></p><p class="c6"><span class="c3">s3_output = &#39;s3://</span><span class="c3">dh-2020</span><span class="c12">-</span><span class="c21 c27">[SUFFIX]</span><span class="c3">/athena-practice/results/</span><span class="c1">&#39;</span></p><p class="c6"><span class="c1">database = &#39;default&#39;</span></p><p class="c6"><span class="c1">response = athena.start_query_execution(</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; QueryString=query,</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; QueryExecutionContext={</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &#39;Database&#39;: database</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; },</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; ResultConfiguration={</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &#39;OutputLocation&#39;: s3_output,</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; )</span></p><p class="c6 c5"><span class="c1"></span></p><p class="c6"><span class="c1">qe_id = response[&#39;QueryExecutionId&#39;]</span></p><p class="c6"><span class="c1">print(&#39;Execution ID: &#39; + qe_id)</span></p><p class="c6 c5"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">En este punto quedamos con un diccionario de Python que describe la query que se est&aacute; ejecutando pero no tenemos su resultado.</span></p><p class="c4"><span class="c0">Para obtenerlo tenemos que esperar a que la query termine:</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.5443aa17c442d28c7a5d2761b8b4b3d9af13d612"></a><a id="t.11"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c1">status = None</span></p><p class="c6"><span class="c1">while True:</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; response = athena.get_query_execution(QueryExecutionId=qe_id)</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; status = response[&#39;QueryExecution&#39;][&#39;Status&#39;][&#39;State&#39;]</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; print(status)</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; if status != &#39;RUNNING&#39;:</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; break</span></p><p class="c6"><span class="c1">&nbsp; &nbsp; sleep(1)</span></p><p class="c6 c5"><span class="c1"></span></p><p class="c6"><span class="c1">print(response[&#39;QueryExecution&#39;][&#39;ResultConfiguration&#39;][&#39;OutputLocation&#39;])</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Este c&oacute;digo pregunta el estado de la query a cada segundo hasta que la misma deja de estar en estado RUNNING.</span></p><p class="c4"><span class="c0">Una vez que esto ocurre se imprime la ruta de S3 donde se dejaron los archivo.</span></p><p class="c4 c5"><span class="c0"></span></p><hr style="page-break-before:always;display:none;"><h1 class="c11 c33" id="h.6zjb08wayn3b"><span class="c14"></span></h1><h1 class="c11" id="h.mcoil2i2cvar"><span>BONUS 1</span><span class="c14">: Consumir datos demograficos georeferenciados</span></h1><p class="c4"><span class="c0">Hace un tiempo Facebook public&oacute; un dataset con este tipo de informaci&oacute;n en S3.<br>Gracias a Athena estos datos pueden ser procesados sin necesidad de descargarlos. </span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">El siguiente tutorial explica como crear la tablas:</span></p><p class="c4"><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://docs.opendata.aws/dataforgood-fb-data/readme.html&amp;sa=D&amp;ust=1595373300066000&amp;usg=AOvVaw3XgNiA4f_lkSMyxv8X0drI">https://docs.opendata.aws/dataforgood-fb-data/readme.html</a></span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span class="c0">Este otro explica explica con mayor detalle la sem&aacute;ntica de las columnas y contiene algunos ejemplos de queries geogr&aacute;ficas.</span></p><p class="c4"><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://dataforgood.fb.com/docs/using-hrsl-public-dataset-with-athena/&amp;sa=D&amp;ust=1595373300067000&amp;usg=AOvVaw12JSNTGkmlQBtXcxtYVEsQ">https://dataforgood.fb.com/docs/using-hrsl-public-dataset-with-athena/</a></span></p><p class="c4 c5"><span class="c0"></span></p><h1 class="c11" id="h.4jfu9vnwxz3c"><span class="c14">BONUS 2: S3 Select</span></h1><p class="c4"><span>En este ejercicio vamos a probar el servicio </span><span class="c21">S3 Select</span><span class="c0">, el cual permite conectarnos a un bucket S3 y obtener &uacute;nicamente la porci&oacute;n de los datos que necesitamos, utilizando expresiones SQL.</span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span>El siguiente tutorial, en la secci&oacute;n </span><span class="c21">S3 Select</span><span class="c0">, se explica el funcionamiento de este servicio.</span></p><p class="c4"><span class="c13"><a class="c32" href="https://www.google.com/url?q=https://aws.amazon.com/es/blogs/aws/s3-glacier-select/&amp;sa=D&amp;ust=1595373300068000&amp;usg=AOvVaw3lAcB3fayJzuvnJJWZrsny">https://aws.amazon.com/es/blogs/aws/s3-glacier-select/</a></span></p><p class="c4 c5"><span class="c0"></span></p><p class="c4"><span>Se propone recrear el ejemplo del tutorial con un archivo simple a elecci&oacute;n del alumno. Reemplazar el c&oacute;digo en </span><span class="c18">rojo</span><span>&nbsp;por los datos del </span><span class="c18">bucket</span><span>, </span><span class="c18">archivo</span><span>&nbsp;y </span><span class="c18">query</span><span class="c0">&nbsp;elegidos por el alumno.</span></p><p class="c4 c5"><span class="c0"></span></p><a id="t.0d5c7e0308633e3b5df2a98370fda9f0341fc4c3"></a><a id="t.12"></a><table class="c16"><tbody><tr class="c23"><td class="c22" colspan="1" rowspan="1"><p class="c6"><span class="c24 c30">import</span><span class="c1">&nbsp;boto3</span></p><p class="c6"><span class="c3">s3 </span><span class="c24 c31">=</span><span class="c3">&nbsp;boto3</span><span class="c7">.</span><span class="c3">client</span><span class="c7">(</span><span class="c24 c26">&#39;s3&#39;</span><span class="c7">)</span></p><p class="c6 c5"><span class="c1"></span></p><p class="c6"><span class="c3">r </span><span class="c24 c31">=</span><span class="c3">&nbsp;s3</span><span class="c7">.</span><span class="c3">select_object_content</span><span class="c7">(</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; Bucket</span><span class="c24 c31">=</span><span class="c24 c21 c25">&#39;</span><span class="c24 c18">jbarr-us-west-2</span><span class="c24 c25 c21">&#39;</span><span class="c7">,</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; Key</span><span class="c12 c19">=</span><span class="c12 c15">&#39;</span><span class="c18 c24">sample-data/airportCodes.csv</span><span class="c24 c26">&#39;</span><span class="c7">,</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; ExpressionType</span><span class="c24 c31">=</span><span class="c24 c26">&#39;SQL&#39;</span><span class="c7">,</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; Expression</span><span class="c24 c31">=</span><span class="c24 c26">&quot;</span><span class="c24 c18">select * from s3object s where s.\&quot;Country (Name)\&quot; like &#39;%United States%&#39;</span><span class="c24 c26">&quot;</span><span class="c7">,</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; InputSerialization </span><span class="c24 c31">=</span><span class="c3">&nbsp;</span><span class="c7">{</span><span class="c15 c12">&#39;CSV&#39;</span><span class="c7">:</span><span class="c3">&nbsp;</span><span class="c7">{</span><span class="c24 c26">&quot;FileHeaderInfo&quot;</span><span class="c7">:</span><span class="c3">&nbsp;</span><span class="c24 c26">&quot;Use&quot;</span><span class="c7">}},</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; OutputSerialization </span><span class="c24 c31">=</span><span class="c3">&nbsp;</span><span class="c7">{</span><span class="c24 c26">&#39;CSV&#39;</span><span class="c7">:</span><span class="c3">&nbsp;</span><span class="c7">{}},</span></p><p class="c6"><span class="c7">)</span></p><p class="c6 c5"><span class="c1"></span></p><p class="c6"><span class="c12 c20">for</span><span class="c3">&nbsp;event </span><span class="c24 c30">in</span><span class="c3">&nbsp;r</span><span class="c7">[</span><span class="c24 c26">&#39;Payload&#39;</span><span class="c7">]:</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c24 c30">if</span><span class="c3">&nbsp;</span><span class="c24 c26">&#39;Records&#39;</span><span class="c3">&nbsp;</span><span class="c20 c12">in</span><span class="c3">&nbsp;event</span><span class="c7">:</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; records </span><span class="c24 c31">=</span><span class="c3">&nbsp;event</span><span class="c7">[</span><span class="c24 c26">&#39;Records&#39;</span><span class="c7">][</span><span class="c24 c26">&#39;Payload&#39;</span><span class="c7">].</span><span class="c3">decode</span><span class="c7">(</span><span class="c24 c26">&#39;utf-8&#39;</span><span class="c7">)</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c24 c30">print</span><span class="c7">(</span><span class="c3">records</span><span class="c7">)</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c24 c30">elif</span><span class="c3">&nbsp;</span><span class="c15 c12">&#39;Stats&#39;</span><span class="c3">&nbsp;</span><span class="c24 c30">in</span><span class="c3">&nbsp;event</span><span class="c7">:</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; statsDetails </span><span class="c24 c31">=</span><span class="c3">&nbsp;event</span><span class="c7">[</span><span class="c24 c26">&#39;Stats&#39;</span><span class="c7">][</span><span class="c24 c26">&#39;Details&#39;</span><span class="c7">]</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c24 c30">print</span><span class="c7">(</span><span class="c15 c12">&quot;Stats details bytesScanned: &quot;</span><span class="c2">)</span></p><p class="c6"><span class="c24 c30">&nbsp; &nbsp; &nbsp; &nbsp; print</span><span class="c7">(</span><span class="c3">statsDetails</span><span class="c7">[</span><span class="c24 c26">&#39;BytesScanned&#39;</span><span class="c7">])</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c24 c30">print</span><span class="c7">(</span><span class="c24 c26">&quot;Stats details bytesProcessed: &quot;</span><span class="c7">)</span></p><p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c24 c30">print</span><span class="c7">(</span><span class="c3">statsDetails</span><span class="c7">[</span><span class="c24 c26">&#39;BytesProcessed&#39;</span><span class="c2">])</span></p></td></tr></tbody></table><p class="c4 c5"><span class="c0"></span></p><p class="c4 c5"><span class="c0"></span></p></body></html>